import { useState, useEffect, useCallback, useRef } from "react";
import { onAuthChange, registerWithEmail, loginWithEmail, loginWithGoogle, logoutUser, getCurrentUid, checkUsernameAvailable, createUserProfile, getUserProfile, updateUserProfile, shareAdventure, getPosts, toggleLikePost, addCommentToPost, getComments, deleteComment, deletePost, getOrCreateConversation, sendMessage, getMessages, getConversations, getUserProfileByUsername, getUserPosts, sendFriendRequest, getPendingRequests, getSentRequests, acceptFriendRequest, rejectFriendRequest, removeFriend, getFriends, searchUsers } from "./firebase";
import { ADVENTURES_TR, ADVENTURES_EN } from "./adventures";
import { t, tf, addTranslations, friendTranslations } from "./i18n";
const storage={get:(k)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):null}catch{return null}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}}};
const CAT_META=[{id:"explore",emoji:"ğŸ§­",color:"#FF6B35"},{id:"social",emoji:"ğŸ‘‹",color:"#4ECDC4"},{id:"creative",emoji:"ğŸ¨",color:"#A855F7"},{id:"mindful",emoji:"ğŸ§˜",color:"#06B6D4"},{id:"food",emoji:"ğŸ³",color:"#F59E0B"},{id:"fitness",emoji:"ğŸƒ",color:"#EF4444"}];
const DIFF_META=[{id:"easy",emoji:"ğŸŒ±"},{id:"medium",emoji:"âš¡"},{id:"hard",emoji:"ğŸ”¥"}];
const ENV_META=[{id:"home",emoji:"ğŸ "},{id:"outdoor",emoji:"ğŸŒ³"},{id:"place",emoji:"ğŸ›ï¸"},{id:"any",emoji:"ğŸ²"}];
const BADGE_META=[{id:"first",emoji:"ğŸ‘£",req:1},{id:"five",emoji:"â­",req:5},{id:"ten",emoji:"ğŸ…",req:10},{id:"twenty",emoji:"ğŸ¯",req:20},{id:"month",emoji:"ğŸŒ™",req:30},{id:"fifty",emoji:"ğŸ‘‘",req:50},{id:"streak3",emoji:"ğŸ”¥",req:"streak3"},{id:"streak7",emoji:"ğŸ’",req:"streak7"},{id:"streak14",emoji:"ğŸ†",req:"streak14"},{id:"allcat",emoji:"ğŸŒˆ",req:"allcat"},{id:"location",emoji:"ğŸ“",req:"location"}];
const DEFAULT_STATE={interests:[],difficulty:"easy",xp:0,level:1,streak:0,bestStreak:0,completedAdventures:[],lastCompletedDate:null,todayAdventure:null,todayDate:null,onboarded:false,locationEnabled:false,city:null,lat:null,lon:null,nearbyPlaces:[],locationAdventureCount:0,skipsToday:0,lang:"tr",notificationsEnabled:false};
function getCats(lang){return CAT_META.map(c=>({...c,label:t(lang,"categories."+c.id)}))}
function getDiffs(lang){return DIFF_META.map(d=>({...d,label:t(lang,"difficulty."+d.id),desc:t(lang,"difficulty."+d.id+"Sub")}))}
function getEnvs(lang){return ENV_META.map(e=>({...e,label:t(lang,"environments."+e.id),desc:t(lang,"environments."+e.id+"Sub")}))}
function getBadges(lang){return BADGE_META.map(b=>({...b,name:t(lang,"badges."+b.id)}))}
function getToday(){return new Date().toISOString().split("T")[0]}
function xpForLevel(l){return l*120}
function earnedBadges(s,lang){const total=s.completedAdventures.length;const c=new Set(s.completedAdventures.map(a=>a.category));return getBadges(lang).filter(b=>{if(b.req==="streak3")return s.bestStreak>=3;if(b.req==="streak7")return s.bestStreak>=7;if(b.req==="streak14")return s.bestStreak>=14;if(b.req==="allcat")return c.size>=6;if(b.req==="location")return(s.locationAdventureCount||0)>=5;return total>=b.req})}
function timeAgo(ts,lang){if(!ts)return"";const now=Date.now();const tm=ts.toDate?ts.toDate().getTime():typeof ts==="number"?ts:Date.now();const d=Math.floor((now-tm)/1000);if(lang==="en"){if(d<60)return"Now";if(d<3600)return Math.floor(d/60)+" min ago";if(d<86400)return Math.floor(d/3600)+" hr ago";return Math.floor(d/86400)+" days ago"}if(d<60)return"Åimdi";if(d<3600)return Math.floor(d/60)+" dk Ã¶nce";if(d<86400)return Math.floor(d/3600)+" saat Ã¶nce";return Math.floor(d/86400)+" gÃ¼n Ã¶nce"}
function getAdventures(lang){return lang==="en"?ADVENTURES_EN:ADVENTURES_TR}
function mapLink(lat,lon,name,city){const q=(name||"")+(city?", "+city:"");return"https://www.google.com/maps/place/"+encodeURIComponent(q)+"/@"+lat+","+lon+",17z"}
function mapLinkName(name,city){return`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(name+(city?", "+city:""))}`}
async function fetchNearbyPlaces(lat,lon){const r=2000;const q=`[out:json][timeout:10];(node["tourism"~"museum|artwork|viewpoint|attraction"](around:${r},${lat},${lon});node["historic"](around:${r},${lat},${lon});node["amenity"~"cafe|restaurant|library|marketplace"](around:${r},${lat},${lon});node["leisure"~"park|garden"](around:${r},${lat},${lon});node["shop"~"books|antiques|bakery"](around:${r},${lat},${lon});way["leisure"="park"](around:${r},${lat},${lon}););out body 40;`;try{const res=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:"data="+encodeURIComponent(q)});const data=await res.json();return data.elements.filter(e=>e.tags&&(e.tags.name||e.tags["name:tr"])).map(e=>({name:e.tags["name:tr"]||e.tags.name,type:e.tags.tourism||e.tags.historic||e.tags.amenity||e.tags.leisure||e.tags.shop||"place",lat:e.lat||e.center?.lat,lon:e.lon||e.center?.lon})).slice(0,30)}catch{return[]}}
function generatePlaceAdventure(place,interests,lang,city){const isEN=lang==="en";const templates={museum:[{title:`ğŸ“ ${place.name}`,description:isEN?`Visit ${place.name} museum.`:`${place.name} mÃ¼zesini ziyaret et.`,tips:isEN?"Check opening hours!":"GiriÅŸ saatlerini kontrol et!",category:"explore",xp:45}],cafe:[{title:`ğŸ“ ${place.name}`,description:isEN?`Go to ${place.name}, try something new.`:`${place.name}'e git, yeni bir ÅŸey dene.`,tips:isEN?"Pick the most interesting item!":"En ilginÃ§ ÅŸeyi seÃ§!",category:"food",xp:30}],park:[{title:`ğŸ“ ${place.name}`,description:isEN?`Walk 20 min in ${place.name}.`:`${place.name}'de 20 dk yÃ¼rÃ¼.`,tips:isEN?"Listen to the birds.":"KuÅŸ seslerini dinle.",category:"fitness",xp:35}],place:[{title:`ğŸ“ ${place.name}`,description:isEN?`Visit ${place.name}, explore for 10 min.`:`${place.name}'e git, 10 dk keÅŸfet.`,tips:isEN?"Beauty is in the details.":"Detaylarda gÃ¼zellik var.",category:"explore",xp:35}]};const tp=templates[place.type]||templates.place;const f=tp.filter(x=>interests.includes(x.category));const p=f.length>0?f:tp;return{...p[Math.floor(Math.random()*p.length)],isLocation:true,placeName:place.name,placeLat:place.lat,placeLon:place.lon,placeCity:city||""}}
function getRandomAdventure(interests,difficulty,completedTitles,nearbyPlaces,useLocation,env,lang,city){const ADVS=getAdventures(lang);if(useLocation&&nearbyPlaces&&nearbyPlaces.length>0&&(!env||env==="place"||env==="any")&&Math.random()<0.45){const up=nearbyPlaces.filter(p=>!completedTitles.some(t=>t.includes(p.name)));const pp=up.length>0?up:nearbyPlaces;const place=pp[Math.floor(Math.random()*pp.length)];const adv=generatePlaceAdventure(place,interests,lang,city);if(difficulty==="medium")adv.xp=Math.round(adv.xp*1.5);if(difficulty==="hard")adv.xp=adv.xp*2;return adv}let pool=[];interests.forEach(cat=>{(ADVS[cat]||[]).forEach(a=>{if(!completedTitles.includes(a.title)){if(!env||env==="any"||a.env===env||a.env==="any")pool.push({...a,category:cat})}})});if(pool.length===0)interests.forEach(cat=>{(ADVS[cat]||[]).forEach(a=>{if(!env||env==="any"||a.env===env||a.env==="any")pool.push({...a,category:cat})})});if(pool.length===0)interests.forEach(cat=>{(ADVS[cat]||[]).forEach(a=>{pool.push({...a,category:cat})})});const adv=pool[Math.floor(Math.random()*pool.length)];if(difficulty==="medium")adv.xp=Math.round(adv.xp*1.5);if(difficulty==="hard")adv.xp=adv.xp*2;return adv}
async function requestNotificationPermission(){if(!("Notification" in window))return"denied";if(Notification.permission==="granted")return"granted";const p=await Notification.requestPermission();return p}
function scheduleLocalNotification(){if("serviceWorker" in navigator&&Notification.permission==="granted"){const now=new Date();const next=new Date();next.setHours(9,0,0,0);if(now>next)next.setDate(next.getDate()+1);const delay=next.getTime()-now.getTime();setTimeout(()=>{navigator.serviceWorker.ready.then(reg=>{reg.showNotification("Wanderly ğŸŒ",{body:"BugÃ¼nkÃ¼ maceran seni bekliyor!",icon:"/icon-192.png",badge:"/icon-192.png",vibrate:[100,50,100]})});scheduleLocalNotification()},delay)}}
function PhotoLightbox({src,onClose}){if(!src)return null;return(<div onClick={onClose} style={{position:"fixed",inset:0,zIndex:9999,background:"rgba(0,0,0,0.92)",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",cursor:"zoom-out"}}><img src={src} style={{maxWidth:"100%",maxHeight:"90vh",borderRadius:"12px",objectFit:"contain"}}/><button onClick={onClose} style={{position:"absolute",top:"16px",right:"16px",width:"40px",height:"40px",borderRadius:"50%",border:"none",background:"rgba(255,255,255,0.15)",color:"#fff",fontSize:"22px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button></div>)}
function AnimatedBg(){return(<div style={{position:"fixed",inset:0,zIndex:0,overflow:"hidden",background:"linear-gradient(135deg,#0F0A1A 0%,#1A1035 40%,#0D1926 100%)"}}>{[...Array(6)].map((_,i)=>(<div key={i} style={{position:"absolute",borderRadius:"50%",filter:"blur(80px)",opacity:0.12,animation:`floatBlob ${14+i*3}s ease-in-out infinite alternate`,background:["#FF6B35","#A855F7","#4ECDC4","#F59E0B","#06B6D4","#EF4444"][i],width:`${200+i*80}px`,height:`${200+i*80}px`,left:`${10+i*15}%`,top:`${10+((i*37)%70)}%`}}/>))}<style>{`@keyframes floatBlob{0%{transform:translate(0,0) scale(1)}100%{transform:translate(30px,-40px) scale(1.2)}}`}</style></div>)}
function Glass({children,style,onClick}){return(<div onClick={onClick} style={{background:"rgba(255,255,255,0.04)",backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:"20px",...style}}>{children}</div>)}
function Avatar({src,name,size=40,border=true}){return(<div style={{width:size,height:size,borderRadius:"50%",overflow:"hidden",background:src?"none":"linear-gradient(135deg,#FF6B35,#A855F7)",display:"flex",alignItems:"center",justifyContent:"center",border:border?`2px solid rgba(255,255,255,0.12)`:"none",flexShrink:0}}>{src?<img src={src} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{color:"#fff",fontSize:size*0.38,fontWeight:700}}>{(name||"?")[0].toUpperCase()}</span>}</div>)}
function UserProfileView({uid:targetUid,username:targetUsername,onBack,onStartDM,lang}){const[prof,setProf]=useState(null);const[posts,setPosts]=useState([]);const[loading,setLoading]=useState(true);const extra=addTranslations(lang);useEffect(()=>{(async()=>{let p=null;if(targetUid)p=await getUserProfile(targetUid);else if(targetUsername)p=await getUserProfileByUsername(targetUsername);if(p){setProf(p);const userPosts=await getUserPosts(p.id);setPosts(userPosts)}setLoading(false)})()},[targetUid,targetUsername]);if(loading)return(<Glass style={{padding:"40px",textAlign:"center",maxWidth:"480px",width:"100%"}}><div style={{fontSize:"28px",animation:"pulse 1.5s infinite"}}>â³</div></Glass>);if(!prof)return(<Glass style={{padding:"40px",textAlign:"center",maxWidth:"480px",width:"100%"}}><p style={{color:"rgba(255,255,255,0.4)"}}>User not found</p><button onClick={onBack} style={{marginTop:"16px",padding:"8px 20px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"none",color:"rgba(255,255,255,0.5)",cursor:"pointer"}}>{extra.userProfile.back}</button></Glass>);const CATS=getCats(lang);const isMe=getCurrentUid()===prof.id;return(<div style={{display:"flex",flexDirection:"column",gap:"12px",maxWidth:"480px",width:"100%"}}><button onClick={onBack} style={{alignSelf:"flex-start",padding:"8px 16px",borderRadius:"10px",border:"none",background:"rgba(255,255,255,0.06)",color:"rgba(255,255,255,0.5)",fontSize:"13px",cursor:"pointer"}}>{extra.userProfile.back}</button><Glass style={{padding:"28px",textAlign:"center"}}><Avatar src={prof.avatar} name={prof.displayName} size={80}/><h2 style={{color:"#fff",fontSize:"20px",fontWeight:700,marginTop:"12px"}}>{prof.displayName}</h2><p style={{color:"rgba(255,255,255,0.4)",fontSize:"13px"}}>@{prof.username}</p><div style={{display:"flex",justifyContent:"center",gap:"24px",marginTop:"20px"}}><div style={{textAlign:"center"}}><div style={{color:"#fff",fontSize:"20px",fontWeight:700}}>{posts.length}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"11px"}}>{extra.userProfile.posts}</div></div></div>{!isMe&&(<div style={{display:"flex",gap:"8px",marginTop:"20px"}}><button onClick={()=>onStartDM(prof)} style={{flex:1,padding:"12px",borderRadius:"14px",border:"none",background:"linear-gradient(135deg,#3B82F6,#2563EB)",color:"#fff",fontSize:"14px",fontWeight:600,cursor:"pointer"}}>{extra.userProfile.sendMessage}</button></div>)}</Glass>{posts.length>0?posts.map(post=>{const cat=CATS.find(c=>c.id===post.category)||CATS[0];return(<Glass key={post.id} style={{padding:"16px 20px"}}><div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"}}><span style={{background:`${cat.color}20`,padding:"4px 10px",borderRadius:"12px",fontSize:"11px",color:cat.color,fontWeight:600}}>{cat.emoji} {cat.label}</span><span style={{color:"rgba(255,255,255,0.3)",fontSize:"11px"}}>{timeAgo(post.createdAt,lang)}</span></div><div style={{color:"rgba(255,255,255,0.7)",fontSize:"14px",fontWeight:600}}>{post.title}</div>{post.note&&<p style={{color:"rgba(255,255,255,0.5)",fontSize:"13px",marginTop:"6px",lineHeight:1.5}}>{post.note}</p>}{post.photo&&<img src={post.photo} style={{width:"100%",borderRadius:"10px",marginTop:"10px",maxHeight:"200px",objectFit:"cover"}}/>}</Glass>)}):(<Glass style={{padding:"30px",textAlign:"center"}}><p style={{color:"rgba(255,255,255,0.3)",fontSize:"13px"}}>{extra.userProfile.noPosts}</p></Glass>)}</div>)}
function FriendsTab({currentUid,lang,onViewProfile}){const[subTab,setSubTab]=useState("friends");const[friends,setFriends]=useState([]);const[friendProfiles,setFriendProfiles]=useState({});const[pendingReqs,setPendingReqs]=useState([]);const[sentReqs,setSentReqs]=useState([]);const[reqProfiles,setReqProfiles]=useState({});const[searchTerm,setSearchTerm]=useState("");const[searchResults,setSearchResults]=useState([]);const[searching,setSearching]=useState(false);const[conversations,setConversations]=useState([]);const[dmChat,setDmChat]=useState(null);const[convProfiles,setConvProfiles]=useState({});const[loading,setLoading]=useState(true);const[feedback,setFeedback]=useState("");const ft=friendTranslations(lang);const extra=addTranslations(lang);const loadAll=async()=>{setLoading(true);const[fr,pr,sr,cv]=await Promise.all([getFriends(currentUid),getPendingRequests(currentUid),getSentRequests(currentUid),getConversations(currentUid)]);setFriends(fr);setPendingReqs(pr);setSentReqs(sr);setConversations(cv);const allUids=new Set();fr.forEach(f=>f.users.forEach(u=>{if(u!==currentUid)allUids.add(u)}));pr.forEach(r=>allUids.add(r.from));sr.forEach(r=>allUids.add(r.to));cv.forEach(c=>c.participants.forEach(p=>{if(p!==currentUid)allUids.add(p)}));const profiles={};await Promise.all([...allUids].map(async uid=>{const p=await getUserProfile(uid);if(p)profiles[uid]={...p,id:uid}}));setFriendProfiles(prev=>({...prev,...profiles}));setReqProfiles(prev=>({...prev,...profiles}));setConvProfiles(prev=>({...prev,...profiles}));setLoading(false)};useEffect(()=>{loadAll()},[]);const handleSearch=async()=>{if(!searchTerm.trim())return;setSearching(true);const results=await searchUsers(searchTerm.trim());setSearchResults(results.filter(u=>u.id!==currentUid));setSearching(false)};const handleSendRequest=async(targetUid)=>{if(targetUid===currentUid){setFeedback(ft.cantAddSelf);return}const res=await sendFriendRequest(currentUid,targetUid);if(res.success){setFeedback(ft.requestSentMsg);await loadAll()}else if(res.error==="already_friends"){setFeedback(ft.alreadyFriends)}else if(res.error==="already_sent"){setFeedback(ft.requestSent)}setTimeout(()=>setFeedback(""),3000)};const handleAccept=async(req)=>{await acceptFriendRequest(req.id,req.from,req.to);setSubTab("friends");await loadAll()};const handleReject=async(req)=>{await rejectFriendRequest(req.id);await loadAll()};const handleRemoveFriend=async(friendDoc,otherUid)=>{if(window.confirm(ft.removeFriend)){await removeFriend(currentUid,otherUid);await loadAll()}};const handleStartChat=async(otherUid)=>{const prof=friendProfiles[otherUid];const convId=await getOrCreateConversation(currentUid,otherUid);if(convId)setDmChat({convId,otherProfile:prof})};if(dmChat)return(<DMChat convId={dmChat.convId} otherProfile={dmChat.otherProfile} currentUid={currentUid} onBack={()=>{setDmChat(null);loadAll()}} lang={lang}/>);const requestCount=pendingReqs.length;return(<div style={{display:"flex",flexDirection:"column",gap:"12px",maxWidth:"480px",width:"100%"}}><div style={{display:"flex",gap:"4px",background:"rgba(255,255,255,0.04)",padding:"3px",borderRadius:"12px"}}>{[{id:"friends",label:ft.friends,emoji:"ğŸ‘¥"},{id:"messages",label:ft.messages,emoji:"âœ‰ï¸"},{id:"requests",label:ft.requests+(requestCount>0?` (${requestCount})`:""),emoji:"ğŸ“©"},{id:"add",label:ft.addFriend,emoji:"ğŸ”"}].map(st=>(<button key={st.id} onClick={()=>setSubTab(st.id)} style={{flex:1,padding:"9px 4px",borderRadius:"9px",border:"none",background:subTab===st.id?"rgba(255,255,255,0.1)":"transparent",color:subTab===st.id?"#fff":"rgba(255,255,255,0.4)",fontSize:"11px",fontWeight:600,cursor:"pointer"}}>{st.emoji} {st.label}</button>))}</div>{feedback&&<div style={{padding:"10px",borderRadius:"10px",background:"rgba(16,185,129,0.1)",color:"#10B981",fontSize:"13px",textAlign:"center",animation:"fadeUp 0.3s ease"}}>{feedback}</div>}{loading?(<Glass style={{padding:"40px",textAlign:"center"}}><div style={{fontSize:"28px",animation:"pulse 1.5s infinite"}}>â³</div></Glass>):<>{subTab==="friends"&&(<div style={{display:"flex",flexDirection:"column",gap:"8px"}}>{friends.length===0?(<Glass style={{padding:"36px",textAlign:"center"}}><div style={{fontSize:"40px",marginBottom:"12px"}}>ğŸ‘¥</div><p style={{color:"rgba(255,255,255,0.4)",fontSize:"14px"}}>{ft.noFriends}</p><p style={{color:"rgba(255,255,255,0.25)",fontSize:"12px",marginTop:"6px"}}>{ft.noFriendsSub}</p></Glass>):friends.map(f=>{const otherUid=f.users.find(u=>u!==currentUid);const prof=friendProfiles[otherUid];if(!prof)return null;return(<Glass key={f.id} style={{padding:"12px 16px",display:"flex",alignItems:"center",gap:"12px"}}><div onClick={()=>onViewProfile&&onViewProfile(otherUid)} style={{cursor:"pointer"}}><Avatar src={prof.avatar} name={prof.displayName} size={44}/></div><div style={{flex:1,minWidth:0}} onClick={()=>onViewProfile&&onViewProfile(otherUid)}><div style={{color:"#fff",fontSize:"14px",fontWeight:600,cursor:"pointer"}}>{prof.displayName}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px"}}>@{prof.username}</div></div><div style={{display:"flex",gap:"6px"}}><button onClick={()=>handleStartChat(otherUid)} style={{padding:"8px 12px",borderRadius:"10px",border:"none",background:"linear-gradient(135deg,#3B82F6,#2563EB)",color:"#fff",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>{ft.startChat}</button><button onClick={()=>handleRemoveFriend(f,otherUid)} style={{padding:"8px 10px",borderRadius:"10px",border:"1px solid rgba(239,68,68,0.3)",background:"rgba(239,68,68,0.08)",color:"#EF4444",fontSize:"11px",cursor:"pointer"}}>âœ•</button></div></Glass>)})}</div>)}{subTab==="messages"&&(<div style={{display:"flex",flexDirection:"column",gap:"8px"}}>{conversations.length===0?(<Glass style={{padding:"36px",textAlign:"center"}}><div style={{fontSize:"40px",marginBottom:"12px"}}>âœ‰ï¸</div><p style={{color:"rgba(255,255,255,0.4)",fontSize:"14px"}}>{extra.dm.noConversations}</p></Glass>):conversations.map(c=>{const otherId=c.participants.find(p=>p!==currentUid);const prof=convProfiles[otherId];return(<Glass key={c.id} onClick={()=>setDmChat({convId:c.id,otherProfile:prof})} style={{padding:"14px 18px",display:"flex",alignItems:"center",gap:"12px",cursor:"pointer"}}><Avatar src={prof?.avatar} name={prof?.displayName||"?"} size={44}/><div style={{flex:1,minWidth:0}}><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>{prof?.displayName||"..."}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",marginTop:"2px"}}>{c.lastMessage||"..."}</div></div><div style={{color:"rgba(255,255,255,0.2)",fontSize:"11px"}}>{timeAgo(c.lastMessageAt,lang)}</div></Glass>)})}</div>)}{subTab==="requests"&&(<div style={{display:"flex",flexDirection:"column",gap:"12px"}}>{pendingReqs.length>0&&(<div><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"8px"}}>{ft.incomingRequests}</div>{pendingReqs.map(req=>{const prof=reqProfiles[req.from];return(<Glass key={req.id} style={{padding:"12px 16px",display:"flex",alignItems:"center",gap:"12px"}}><Avatar src={prof?.avatar} name={prof?.displayName||"?"} size={40}/><div style={{flex:1}}><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>{prof?.displayName||"..."}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px"}}>@{prof?.username||"..."}</div></div><div style={{display:"flex",gap:"6px"}}><button onClick={()=>handleAccept(req)} style={{padding:"8px 14px",borderRadius:"10px",border:"none",background:"linear-gradient(135deg,#10B981,#059669)",color:"#fff",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>{ft.accept}</button><button onClick={()=>handleReject(req)} style={{padding:"8px 12px",borderRadius:"10px",border:"1px solid rgba(255,255,255,0.15)",background:"rgba(255,255,255,0.04)",color:"rgba(255,255,255,0.5)",fontSize:"12px",cursor:"pointer"}}>{ft.reject}</button></div></Glass>)})}</div>)}{sentReqs.length>0&&(<div><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"8px"}}>{ft.sentRequests}</div>{sentReqs.map(req=>{const prof=reqProfiles[req.to];return(<Glass key={req.id} style={{padding:"12px 16px",display:"flex",alignItems:"center",gap:"12px"}}><Avatar src={prof?.avatar} name={prof?.displayName||"?"} size={40}/><div style={{flex:1}}><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>{prof?.displayName||"..."}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px"}}>@{prof?.username||"..."}</div></div><span style={{padding:"6px 12px",borderRadius:"10px",background:"rgba(255,255,255,0.06)",color:"rgba(255,255,255,0.3)",fontSize:"12px"}}>{ft.pending}</span></Glass>)})}</div>)}{pendingReqs.length===0&&sentReqs.length===0&&(<Glass style={{padding:"36px",textAlign:"center"}}><div style={{fontSize:"36px",marginBottom:"12px"}}>ğŸ“©</div><p style={{color:"rgba(255,255,255,0.4)",fontSize:"14px"}}>{ft.noRequests}</p></Glass>)}</div>)}{subTab==="add"&&(<div style={{display:"flex",flexDirection:"column",gap:"12px"}}><div style={{display:"flex",gap:"8px"}}><input type="text" value={searchTerm} onChange={e=>setSearchTerm(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g,""))} onKeyDown={e=>e.key==="Enter"&&handleSearch()} placeholder={ft.searchPlaceholder} style={{flex:1,padding:"12px 16px",borderRadius:"14px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",outline:"none",boxSizing:"border-box"}}/><button onClick={handleSearch} disabled={searching||!searchTerm.trim()} style={{padding:"12px 20px",borderRadius:"14px",border:"none",background:searchTerm.trim()?"linear-gradient(135deg,#FF6B35,#A855F7)":"rgba(255,255,255,0.06)",color:searchTerm.trim()?"#fff":"rgba(255,255,255,0.2)",fontSize:"14px",fontWeight:600,cursor:searchTerm.trim()?"pointer":"default"}}>{searching?"â³":ft.search}</button></div>{searchResults.map(user=>{const isFriend=friends.some(f=>f.users.includes(user.id));const isPending=sentReqs.some(r=>r.to===user.id);const isIncoming=pendingReqs.some(r=>r.from===user.id);return(<Glass key={user.id} style={{padding:"12px 16px",display:"flex",alignItems:"center",gap:"12px"}}><Avatar src={user.avatar} name={user.displayName} size={44}/><div style={{flex:1}}><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>{user.displayName}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px"}}>@{user.username}</div></div>{isFriend?(<span style={{padding:"6px 12px",borderRadius:"10px",background:"rgba(16,185,129,0.1)",color:"#10B981",fontSize:"12px",fontWeight:600}}>âœ“ {ft.alreadyFriends}</span>):isPending?(<span style={{padding:"6px 12px",borderRadius:"10px",background:"rgba(255,255,255,0.06)",color:"rgba(255,255,255,0.3)",fontSize:"12px"}}>{ft.requestSent}</span>):isIncoming?(<button onClick={()=>{const req=pendingReqs.find(r=>r.from===user.id);if(req)handleAccept(req)}} style={{padding:"8px 14px",borderRadius:"10px",border:"none",background:"linear-gradient(135deg,#10B981,#059669)",color:"#fff",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>{ft.accept}</button>):(<button onClick={()=>handleSendRequest(user.id)} style={{padding:"8px 14px",borderRadius:"10px",border:"none",background:"linear-gradient(135deg,#FF6B35,#A855F7)",color:"#fff",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>{ft.sendRequest}</button>)}</Glass>)})}{searchResults.length===0&&searchTerm&&!searching&&(<Glass style={{padding:"24px",textAlign:"center"}}><p style={{color:"rgba(255,255,255,0.3)",fontSize:"13px"}}>{ft.userNotFound}</p></Glass>)}</div>)}</>}</div>)}
function DMChat({convId,otherProfile,currentUid,onBack,lang}){const[messages,setMessages]=useState([]);const[text,setText]=useState("");const[loading,setLoading]=useState(true);const bottomRef=useRef(null);const extra=addTranslations(lang);const loadMsgs=async()=>{const msgs=await getMessages(convId);setMessages(msgs);setLoading(false)};useEffect(()=>{loadMsgs();const interval=setInterval(loadMsgs,5000);return()=>clearInterval(interval)},[convId]);useEffect(()=>{bottomRef.current?.scrollIntoView({behavior:"smooth"})},[messages]);const handleSend=async()=>{if(!text.trim())return;const msg=text.trim();setText("");setMessages(prev=>[...prev,{uid:currentUid,text:msg,createdAt:{toDate:()=>new Date()}}]);const ok=await sendMessage(convId,{uid:currentUid,text:msg});if(!ok){console.error("Failed to send message")}await loadMsgs()};return(<div style={{display:"flex",flexDirection:"column",maxWidth:"480px",width:"100%",height:"calc(100vh - 180px)"}}><div style={{display:"flex",alignItems:"center",gap:"12px",marginBottom:"16px"}}><button onClick={onBack} style={{padding:"8px 14px",borderRadius:"10px",border:"none",background:"rgba(255,255,255,0.06)",color:"rgba(255,255,255,0.5)",fontSize:"13px",cursor:"pointer"}}>{extra.dm.back}</button><Avatar src={otherProfile?.avatar} name={otherProfile?.displayName} size={36}/><div><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>{otherProfile?.displayName}</div><div style={{color:"rgba(255,255,255,0.3)",fontSize:"11px"}}>@{otherProfile?.username}</div></div></div><div style={{flex:1,overflowY:"auto",display:"flex",flexDirection:"column",gap:"8px",paddingBottom:"12px"}}>{loading?<div style={{textAlign:"center",color:"rgba(255,255,255,0.3)",padding:"20px"}}>â³</div>:messages.map((m,i)=>{const isMe=m.uid===currentUid;return(<div key={i} style={{display:"flex",justifyContent:isMe?"flex-end":"flex-start"}}><div style={{maxWidth:"75%",padding:"10px 14px",borderRadius:isMe?"16px 16px 4px 16px":"16px 16px 16px 4px",background:isMe?"linear-gradient(135deg,#3B82F6,#2563EB)":"rgba(255,255,255,0.08)",color:"#fff",fontSize:"14px",lineHeight:1.5}}>{m.text}<div style={{fontSize:"10px",color:isMe?"rgba(255,255,255,0.5)":"rgba(255,255,255,0.25)",marginTop:"4px",textAlign:"right"}}>{timeAgo(m.createdAt,lang)}</div></div></div>)})}<div ref={bottomRef}/></div><div style={{display:"flex",gap:"8px",paddingTop:"12px"}}><input type="text" value={text} onChange={e=>setText(e.target.value)} onKeyDown={e=>e.key==="Enter"&&handleSend()} placeholder={extra.dm.typeMessage} style={{flex:1,padding:"12px 16px",borderRadius:"14px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",outline:"none",boxSizing:"border-box"}}/><button onClick={handleSend} style={{padding:"12px 20px",borderRadius:"14px",border:"none",background:text.trim()?"linear-gradient(135deg,#3B82F6,#2563EB)":"rgba(255,255,255,0.06)",color:text.trim()?"#fff":"rgba(255,255,255,0.2)",fontSize:"14px",fontWeight:600,cursor:text.trim()?"pointer":"default"}}>{extra.dm.send}</button></div></div>)}
function AuthScreen({onAuth,lang,setLang}){const[mode,setMode]=useState("login");const[email,setEmail]=useState("");const[pass,setPass]=useState("");const[error,setError]=useState("");const[loading,setLoading]=useState(false);const L=k=>t(lang,"auth."+k);const handleEmail=async()=>{setError("");setLoading(true);if(mode==="login"){const r=await loginWithEmail(email,pass);if(r.error)setError(r.error);else onAuth(r.uid)}else{const r=await registerWithEmail(email,pass);if(r.error)setError(r.error);else onAuth(r.uid)}setLoading(false)};const handleGoogle=async()=>{setError("");setLoading(true);const r=await loginWithGoogle();if(r.error)setError(r.error);else onAuth(r.uid,r.displayName);setLoading(false)};return(<div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",position:"relative",zIndex:1}}><Glass style={{maxWidth:"420px",width:"100%",padding:"40px 32px",textAlign:"center"}}><div style={{position:"absolute",top:"16px",right:"16px",display:"flex",gap:"4px"}}><button onClick={()=>setLang("tr")} style={{padding:"4px 10px",borderRadius:"8px",border:"none",background:lang==="tr"?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.04)",color:lang==="tr"?"#fff":"rgba(255,255,255,0.4)",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>TR</button><button onClick={()=>setLang("en")} style={{padding:"4px 10px",borderRadius:"8px",border:"none",background:lang==="en"?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.04)",color:lang==="en"?"#fff":"rgba(255,255,255,0.4)",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>EN</button></div><div style={{fontSize:"56px",marginBottom:"12px"}}>ğŸŒ</div><h1 style={{fontFamily:"'Playfair Display',Georgia,serif",fontSize:"32px",fontWeight:700,color:"#fff",marginBottom:"6px"}}>Wanderly</h1><p style={{color:"rgba(255,255,255,0.45)",fontSize:"14px",marginBottom:"28px"}}>{L("title")}</p><button onClick={handleGoogle} disabled={loading} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"1px solid rgba(255,255,255,0.15)",background:"rgba(255,255,255,0.06)",color:"#fff",fontSize:"15px",fontWeight:600,cursor:"pointer",marginBottom:"16px",display:"flex",alignItems:"center",justifyContent:"center",gap:"10px"}}><span style={{fontSize:"20px"}}>ğŸ”µ</span>{mode==="login"?L("loginGoogle"):L("registerGoogle")}</button><div style={{display:"flex",alignItems:"center",gap:"12px",marginBottom:"16px"}}><div style={{flex:1,height:"1px",background:"rgba(255,255,255,0.1)"}}/><span style={{color:"rgba(255,255,255,0.3)",fontSize:"12px"}}>{L("or")}</span><div style={{flex:1,height:"1px",background:"rgba(255,255,255,0.1)"}}/></div><input type="email" placeholder={L("email")} value={email} onChange={e=>setEmail(e.target.value)} style={{width:"100%",padding:"13px 16px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",outline:"none",marginBottom:"10px",boxSizing:"border-box"}}/><input type="password" placeholder={L("password")} value={pass} onChange={e=>setPass(e.target.value)} onKeyDown={e=>e.key==="Enter"&&handleEmail()} style={{width:"100%",padding:"13px 16px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",outline:"none",marginBottom:"14px",boxSizing:"border-box"}}/>{error&&<div style={{color:"#EF4444",fontSize:"13px",marginBottom:"12px",background:"rgba(239,68,68,0.1)",padding:"10px",borderRadius:"10px"}}>{error}</div>}<button onClick={handleEmail} disabled={loading||!email||!pass} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:(email&&pass)?"linear-gradient(135deg,#FF6B35,#A855F7)":"rgba(255,255,255,0.08)",color:"#fff",fontSize:"15px",fontWeight:600,cursor:(email&&pass)?"pointer":"default",opacity:(email&&pass)?1:0.4,marginBottom:"16px"}}>{loading?"â³":mode==="login"?L("login"):L("register")}</button><p style={{color:"rgba(255,255,255,0.4)",fontSize:"13px"}}>{mode==="login"?L("noAccount"):L("hasAccount")}{" "}<span onClick={()=>{setMode(mode==="login"?"register":"login");setError("")}} style={{color:"#A855F7",cursor:"pointer",fontWeight:600}}>{mode==="login"?L("register"):L("login")}</span></p></Glass></div>)}
function ProfileSetup({uid,initialName,onComplete,lang}){const[username,setUsername]=useState("");const[displayName,setDisplayName]=useState(initialName||"");const[avatar,setAvatar]=useState(null);const[checking,setChecking]=useState(false);const[available,setAvailable]=useState(null);const[error,setError]=useState("");const[loading,setLoading]=useState(false);const L=k=>t(lang,"profile."+k);const checkName=async(name)=>{if(name.length<3){setAvailable(null);return}setChecking(true);const ok=await checkUsernameAvailable(name);setAvailable(ok);setChecking(false)};const handleAvatarUpload=(e)=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>{const img=new Image();img.onload=()=>{const c=document.createElement("canvas");c.width=150;c.height=150;const ctx=c.getContext("2d");const s=Math.min(img.width,img.height);const sx=(img.width-s)/2;const sy=(img.height-s)/2;ctx.drawImage(img,sx,sy,s,s,0,0,150,150);setAvatar(c.toDataURL("image/jpeg",0.7))};img.src=ev.target.result};r.readAsDataURL(f)}};const handleSubmit=async()=>{if(!username||username.length<3)return setError(L("usernameMin"));if(!available)return setError(L("usernameTaken"));if(!displayName.trim())return setError(L("displayRequired"));setLoading(true);const res=await createUserProfile(uid,{username:username.trim(),displayName:displayName.trim(),avatar});if(res.error)setError(res.error);else onComplete({username:username.trim(),displayName:displayName.trim(),avatar});setLoading(false)};return(<div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",position:"relative",zIndex:1}}><Glass style={{maxWidth:"420px",width:"100%",padding:"36px 28px",textAlign:"center"}}><h2 style={{color:"#fff",fontSize:"22px",fontWeight:700,marginBottom:"6px"}}>{L("title")}</h2><p style={{color:"rgba(255,255,255,0.4)",fontSize:"13px",marginBottom:"24px"}}>{L("subtitle")}</p><div style={{marginBottom:"20px"}}><label style={{cursor:"pointer"}}><div style={{width:"80px",height:"80px",borderRadius:"50%",background:avatar?"none":"linear-gradient(135deg,#FF6B35,#A855F7)",margin:"0 auto 8px",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden",border:"3px solid rgba(255,255,255,0.15)"}}>{avatar?<img src={avatar} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{color:"#fff",fontSize:"28px"}}>ğŸ“·</span>}</div><input type="file" accept="image/*" style={{display:"none"}} onChange={handleAvatarUpload}/></label><div style={{color:"rgba(255,255,255,0.35)",fontSize:"11px"}}>{L("addPhoto")}</div></div><div style={{position:"relative",marginBottom:"14px"}}><input type="text" placeholder={L("username")} value={username} onChange={e=>{const v=e.target.value.toLowerCase().replace(/[^a-z0-9_]/g,"");setUsername(v);setError("");checkName(v)}} style={{width:"100%",padding:"13px 40px 13px 16px",borderRadius:"12px",border:`1px solid ${available===true?"rgba(16,185,129,0.4)":available===false?"rgba(239,68,68,0.4)":"rgba(255,255,255,0.1)"}`,background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",outline:"none",boxSizing:"border-box"}}/>{username.length>=3&&!checking&&<div style={{position:"absolute",right:"14px",top:"50%",transform:"translateY(-50%)",fontSize:"16px"}}>{available?"âœ…":"âŒ"}</div>}</div><input type="text" placeholder={L("displayName")} value={displayName} onChange={e=>setDisplayName(e.target.value)} style={{width:"100%",padding:"13px 16px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",outline:"none",marginBottom:"14px",boxSizing:"border-box"}}/>{error&&<div style={{color:"#EF4444",fontSize:"13px",marginBottom:"12px",background:"rgba(239,68,68,0.1)",padding:"10px",borderRadius:"10px"}}>{error}</div>}<button onClick={handleSubmit} disabled={loading||!username||!displayName.trim()} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:(username&&displayName.trim())?"linear-gradient(135deg,#FF6B35,#A855F7)":"rgba(255,255,255,0.08)",color:"#fff",fontSize:"15px",fontWeight:600,opacity:(username&&displayName.trim())?1:0.4}}>{loading?L("creating"):L("create")}</button></Glass></div>)}
function Onboarding({onComplete,lang}){const[step,setStep]=useState(0);const[interests,setInterests]=useState([]);const[difficulty,setDifficulty]=useState("easy");const[locationEnabled,setLocationEnabled]=useState(false);const[city,setCity]=useState(null);const[lat,setLat]=useState(null);const[lon,setLon]=useState(null);const[nearbyPlaces,setNearbyPlaces]=useState([]);const[locLoading,setLocLoading]=useState(false);const CATS=getCats(lang);const DIFFS=getDiffs(lang);const L=k=>t(lang,"onboarding."+k);const toggleInterest=(id)=>setInterests(p=>p.includes(id)?p.filter(x=>x!==id):[...p,id]);const requestLocation=()=>{setLocLoading(true);if(navigator.geolocation){navigator.geolocation.getCurrentPosition(async(pos)=>{const lt=pos.coords.latitude,ln=pos.coords.longitude;setLat(lt);setLon(ln);try{const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lt}&lon=${ln}&format=json&accept-language=${lang}`);const data=await res.json();setCity(data.address?.city||data.address?.town||data.address?.province||"OK")}catch{setCity("OK")}const places=await fetchNearbyPlaces(lt,ln);setNearbyPlaces(places);setLocationEnabled(true);setLocLoading(false)},()=>setLocLoading(false))}else setLocLoading(false)};return(<div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",position:"relative",zIndex:1}}><Glass style={{maxWidth:"480px",width:"100%",padding:"40px 32px",textAlign:"center"}}>{step===0&&(<div style={{animation:"fadeUp 0.5s ease"}}><div style={{fontSize:"48px",marginBottom:"12px"}}>ğŸ¯</div><h2 style={{color:"#fff",fontSize:"22px",fontWeight:600,marginBottom:"8px"}}>{L("interests")}</h2><p style={{color:"rgba(255,255,255,0.45)",fontSize:"14px",marginBottom:"24px"}}>{L("interestsSub")}</p><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px",marginBottom:"24px"}}>{CATS.map(cat=>{const sel=interests.includes(cat.id);return(<div key={cat.id} onClick={()=>toggleInterest(cat.id)} style={{padding:"16px 12px",borderRadius:"14px",border:`2px solid ${sel?cat.color:"rgba(255,255,255,0.08)"}`,background:sel?`${cat.color}18`:"rgba(255,255,255,0.02)",cursor:"pointer"}}><div style={{fontSize:"28px",marginBottom:"6px"}}>{cat.emoji}</div><div style={{color:sel?cat.color:"rgba(255,255,255,0.6)",fontSize:"13px",fontWeight:600}}>{cat.label}</div></div>)})}</div><button disabled={interests.length<2} onClick={()=>setStep(1)} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:interests.length>=2?"linear-gradient(135deg,#FF6B35,#A855F7)":"rgba(255,255,255,0.08)",color:"#fff",fontSize:"16px",fontWeight:600,opacity:interests.length>=2?1:0.4}}>{L("continue")}</button></div>)}{step===1&&(<div style={{animation:"fadeUp 0.5s ease"}}><h2 style={{color:"#fff",fontSize:"22px",fontWeight:600,marginBottom:"16px"}}>{L("difficulty")}</h2><div style={{display:"flex",flexDirection:"column",gap:"10px",marginBottom:"24px"}}>{DIFFS.map(d=>{const sel=difficulty===d.id;return(<div key={d.id} onClick={()=>setDifficulty(d.id)} style={{padding:"16px 20px",borderRadius:"14px",border:`2px solid ${sel?"#FF6B35":"rgba(255,255,255,0.08)"}`,background:sel?"rgba(255,107,53,0.1)":"rgba(255,255,255,0.02)",cursor:"pointer",display:"flex",alignItems:"center",gap:"14px"}}><span style={{fontSize:"28px"}}>{d.emoji}</span><div style={{textAlign:"left"}}><div style={{color:sel?"#FF6B35":"#fff",fontWeight:600}}>{d.label}</div><div style={{color:"rgba(255,255,255,0.4)",fontSize:"12px"}}>{d.desc}</div></div></div>)})}</div><button onClick={()=>setStep(2)} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:"linear-gradient(135deg,#FF6B35,#A855F7)",color:"#fff",fontSize:"16px",fontWeight:600,cursor:"pointer"}}>{L("continue")}</button></div>)}{step===2&&(<div style={{animation:"fadeUp 0.5s ease"}}><div style={{fontSize:"48px",marginBottom:"16px"}}>ğŸ“</div><h2 style={{color:"#fff",fontSize:"22px",fontWeight:600,marginBottom:"8px"}}>{L("location")}</h2><p style={{color:"rgba(255,255,255,0.45)",fontSize:"14px",marginBottom:"24px"}}>{L("locationSub")}</p>{locationEnabled?(<div style={{background:"rgba(16,185,129,0.1)",border:"1px solid rgba(16,185,129,0.3)",borderRadius:"14px",padding:"16px",marginBottom:"20px"}}><div style={{color:"#10B981",fontSize:"14px",fontWeight:600}}>âœ“ {L("locationFound")}</div>{city&&<div style={{color:"rgba(255,255,255,0.5)",fontSize:"13px",marginTop:"4px"}}>ğŸ“ {city}</div>}{nearbyPlaces.length>0&&<div style={{color:"rgba(255,255,255,0.4)",fontSize:"12px",marginTop:"6px"}}>ğŸ›ï¸ {tf(lang,"onboarding.placesFound",{n:nearbyPlaces.length})}</div>}</div>):(<button onClick={requestLocation} disabled={locLoading} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"2px solid rgba(255,255,255,0.15)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"15px",fontWeight:600,cursor:"pointer",marginBottom:"12px"}}>{locLoading?`ğŸ“¡ ${L("locationSearch")}`:`ğŸ“ ${L("shareLocation")}`}</button>)}<button onClick={()=>onComplete({interests,difficulty,locationEnabled,city,lat,lon,nearbyPlaces})} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:"linear-gradient(135deg,#FF6B35,#A855F7)",color:"#fff",fontSize:"16px",fontWeight:600,cursor:"pointer",marginTop:"8px"}}>{locationEnabled?L("startAdventure"):L("skipLocation")}</button></div>)}</Glass><style>{`@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}`}</style></div>)}
function AdventureCard({adventure,onComplete,onSkip,skipsLeft,lang}){const[note,setNote]=useState("");const[completing,setCompleting]=useState(false);const[photo,setPhoto]=useState(null);const CATS=getCats(lang);const cat=CATS.find(c=>c.id===adventure.category)||CATS[0];const L=k=>t(lang,"adventure."+k);return(<Glass style={{padding:"0",overflow:"hidden",animation:"fadeUp 0.6s ease",maxWidth:"480px",width:"100%"}}><div style={{background:`linear-gradient(135deg,${cat.color}30,${cat.color}08)`,padding:"28px 24px 20px",borderBottom:"1px solid rgba(255,255,255,0.06)"}}><div style={{display:"flex",alignItems:"center",gap:"10px",marginBottom:"16px",flexWrap:"wrap"}}><span style={{background:`${cat.color}25`,padding:"6px 14px",borderRadius:"20px",fontSize:"13px",color:cat.color,fontWeight:600}}>{cat.emoji} {cat.label}</span>{adventure.isLocation&&<span style={{background:"rgba(16,185,129,0.15)",padding:"6px 12px",borderRadius:"20px",fontSize:"12px",color:"#10B981",fontWeight:600}}>ğŸ“ {L("nearby")}</span>}<span style={{color:"rgba(255,255,255,0.35)",fontSize:"13px"}}>+{adventure.xp} XP</span></div><h2 style={{color:"#fff",fontSize:"22px",fontWeight:700,lineHeight:1.35,marginBottom:"10px",fontFamily:"'Playfair Display',Georgia,serif"}}>{adventure.title}</h2><p style={{color:"rgba(255,255,255,0.55)",fontSize:"15px",lineHeight:1.65}}>{adventure.description}</p>{adventure.isLocation&&adventure.placeLat&&(<a href={mapLink(adventure.placeLat,adventure.placeLon,adventure.placeName,adventure.placeCity)} target="_blank" rel="noopener noreferrer" style={{display:"inline-flex",alignItems:"center",gap:"6px",marginTop:"12px",padding:"8px 14px",borderRadius:"10px",background:"rgba(16,185,129,0.12)",color:"#10B981",fontSize:"13px",fontWeight:600,textDecoration:"none"}}>{t(lang,"map.openMap")}</a>)}{adventure.isLocation&&!adventure.placeLat&&(<a href={mapLinkName(adventure.placeName,adventure.placeCity)} target="_blank" rel="noopener noreferrer" style={{display:"inline-flex",alignItems:"center",gap:"6px",marginTop:"12px",padding:"8px 14px",borderRadius:"10px",background:"rgba(16,185,129,0.12)",color:"#10B981",fontSize:"13px",fontWeight:600,textDecoration:"none"}}>{t(lang,"map.openMap")}</a>)}</div>{adventure.tips&&(<div style={{padding:"16px 24px",borderBottom:"1px solid rgba(255,255,255,0.06)"}}><div style={{color:"rgba(255,255,255,0.35)",fontSize:"11px",fontWeight:700,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"8px"}}>ğŸ’¡ {L("tip")}</div><p style={{color:"rgba(255,255,255,0.5)",fontSize:"13px",lineHeight:1.6}}>{adventure.tips}</p></div>)}<div style={{padding:"20px 24px 24px"}}>{!completing?(<><button onClick={()=>setCompleting(true)} style={{width:"100%",padding:"15px",borderRadius:"14px",border:"none",background:`linear-gradient(135deg,${cat.color},${cat.color}CC)`,color:"#fff",fontSize:"16px",fontWeight:700,cursor:"pointer"}}>âœ“ {L("completed")}</button>{skipsLeft>0?(<button onClick={onSkip} style={{width:"100%",padding:"12px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"transparent",color:"rgba(255,255,255,0.4)",fontSize:"13px",fontWeight:500,cursor:"pointer",marginTop:"8px"}}>ğŸ”„ {tf(lang,"adventure.skip",{n:skipsLeft})}</button>):(<div style={{textAlign:"center",color:"rgba(255,255,255,0.2)",fontSize:"12px",marginTop:"10px"}}>{L("skipDone")}</div>)}</>):(<div style={{animation:"fadeUp 0.3s ease"}}><textarea placeholder={L("howWasIt")} value={note} onChange={e=>setNote(e.target.value)} rows={3} style={{width:"100%",padding:"12px 16px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"14px",resize:"none",outline:"none",marginBottom:"12px",boxSizing:"border-box"}}/>{photo?(<div style={{position:"relative",marginBottom:"12px"}}><img src={photo} style={{width:"100%",borderRadius:"12px",maxHeight:"200px",objectFit:"cover"}}/><button onClick={()=>setPhoto(null)} style={{position:"absolute",top:"8px",right:"8px",width:"28px",height:"28px",borderRadius:"50%",border:"none",background:"rgba(0,0,0,0.6)",color:"#fff",fontSize:"16px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>Ã—</button></div>):(<label style={{display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",width:"100%",padding:"12px",borderRadius:"12px",border:"1px dashed rgba(255,255,255,0.15)",background:"rgba(255,255,255,0.02)",color:"rgba(255,255,255,0.4)",fontSize:"13px",cursor:"pointer",marginBottom:"12px"}}><span>ğŸ“· {L("addPhoto")}</span><input type="file" accept="image/*" style={{display:"none"}} onChange={e=>{const f=e.target.files[0];if(f){const r=new FileReader();r.onload=ev=>setPhoto(ev.target.result);r.readAsDataURL(f)}}}/></label>)}<button onClick={()=>onComplete(note,photo)} style={{width:"100%",padding:"14px",borderRadius:"14px",border:"none",background:"linear-gradient(135deg,#10B981,#059669)",color:"#fff",fontSize:"15px",fontWeight:700,cursor:"pointer"}}>{L("save")}</button></div>)}</div></Glass>)}
function StatsPanel({state,lang}){const xpN=xpForLevel(state.level);const prog=Math.min((state.xp/xpN)*100,100);const badges=earnedBadges(state,lang);const CATS=getCats(lang);const L=k=>t(lang,"stats."+k);return(<Glass style={{padding:"24px",maxWidth:"480px",width:"100%",animation:"fadeUp 0.5s ease"}}><div style={{marginBottom:"20px"}}><div style={{display:"flex",justifyContent:"space-between",marginBottom:"8px"}}><span style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600}}>{L("level")} {state.level}</span><span style={{color:"rgba(255,255,255,0.35)",fontSize:"12px"}}>{state.xp}/{xpN} XP</span></div><div style={{height:"8px",borderRadius:"4px",background:"rgba(255,255,255,0.06)",overflow:"hidden"}}><div style={{height:"100%",width:`${prog}%`,borderRadius:"4px",background:"linear-gradient(90deg,#FF6B35,#A855F7)",transition:"width 0.8s ease"}}/></div></div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"12px",marginBottom:"20px"}}>{[{label:L("adventures"),value:state.completedAdventures.length,emoji:"ğŸ”ï¸"},{label:L("streak"),value:`${state.streak} ${L("day")}`,emoji:"ğŸ”¥"},{label:L("best"),value:`${state.bestStreak} ${L("day")}`,emoji:"ğŸ’"}].map(s=>(<div key={s.label} style={{textAlign:"center",padding:"14px 8px",borderRadius:"12px",background:"rgba(255,255,255,0.03)"}}><div style={{fontSize:"22px",marginBottom:"4px"}}>{s.emoji}</div><div style={{color:"#fff",fontSize:"18px",fontWeight:700}}>{s.value}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"11px",marginTop:"2px"}}>{s.label}</div></div>))}</div>{badges.length>0&&(<div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"11px",fontWeight:700,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"10px"}}>{L("badges")}</div><div style={{display:"flex",gap:"8px",flexWrap:"wrap"}}>{badges.map(b=>(<span key={b.id} style={{background:"rgba(255,255,255,0.06)",padding:"6px 12px",borderRadius:"20px",fontSize:"13px",color:"rgba(255,255,255,0.7)"}}>{b.emoji} {b.name}</span>))}</div></div>)}</Glass>)}
function History({adventures,onPhotoClick,lang}){const CATS=getCats(lang);if(!adventures.length)return(<Glass style={{padding:"40px 24px",textAlign:"center",maxWidth:"480px",width:"100%"}}><div style={{fontSize:"48px",marginBottom:"12px"}}>ğŸ“</div><p style={{color:"rgba(255,255,255,0.4)",fontSize:"14px"}}>{lang==="en"?"No adventures completed yet!":"HenÃ¼z macera tamamlamadÄ±n!"}</p></Glass>);return(<div style={{display:"flex",flexDirection:"column",gap:"10px",maxWidth:"480px",width:"100%"}}>{adventures.slice().reverse().map((a,i)=>{const cat=CATS.find(c=>c.id===a.category)||CATS[0];return(<Glass key={i} style={{padding:"16px 20px",display:"flex",alignItems:"center",gap:"14px",animation:`fadeUp 0.4s ease ${i*0.05}s both`}}><div style={{width:"42px",height:"42px",borderRadius:"12px",background:`${cat.color}20`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"20px",flexShrink:0}}>{cat.emoji}</div><div style={{flex:1,minWidth:0}}><div style={{color:"#fff",fontSize:"14px",fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{a.isLocation&&"ğŸ“ "}{a.title}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px",marginTop:"2px"}}>{a.date} â€¢ +{a.xp} XP</div></div>{a.photo?<img src={a.photo} onClick={(e)=>{e.stopPropagation();onPhotoClick&&onPhotoClick(a.photo)}} style={{width:"48px",height:"48px",borderRadius:"10px",objectFit:"cover",flexShrink:0,cursor:"zoom-in",border:"2px solid rgba(255,255,255,0.1)"}}/>:<div style={{color:"#10B981",fontSize:"18px"}}>âœ“</div>}</Glass>)})}</div>)}
function Community({state,profile,onPhotoClick,lang,onViewProfile}){const[firebasePosts,setFirebasePosts]=useState([]);const[loading,setLoading]=useState(true);const[activeFilter,setActiveFilter]=useState("all");const[openComments,setOpenComments]=useState(null);const[newComment,setNewComment]=useState("");const[postComments,setPostComments]=useState({});const uid=getCurrentUid();const CATS=getCats(lang);const L=k=>t(lang,"community."+k);const loadPosts=async()=>{setLoading(true);const posts=await getPosts(50);setFirebasePosts(posts);setLoading(false)};useEffect(()=>{loadPosts()},[]);const loadComments=async(postId)=>{const cmts=await getComments(postId);setPostComments(prev=>({...prev,[postId]:cmts}))};const handleToggleComments=async(postId)=>{if(openComments===postId){setOpenComments(null)}else{setOpenComments(postId);await loadComments(postId)}};const handleLike=async(postId)=>{if(!uid)return;await toggleLikePost(postId,uid);const posts=await getPosts(50);setFirebasePosts(posts)};const handleComment=async(postId)=>{if(!newComment.trim()||!uid||!profile)return;await addCommentToPost(postId,{uid,username:profile.username,displayName:profile.displayName,avatar:profile.avatar,text:newComment.trim()});setNewComment("");await loadComments(postId)};const handleDeleteComment=async(postId,commentId)=>{if(window.confirm(L("deleteComment"))){await deleteComment(postId,commentId);await loadComments(postId)}};const handleDeletePost=async(postId)=>{if(window.confirm(L("deletePost"))){await deletePost(postId);await loadPosts()}};const allPosts=firebasePosts.map(p=>({...p,isMe:p.uid===uid,time:timeAgo(p.createdAt,lang)}));const filtered=activeFilter==="all"?allPosts:allPosts.filter(p=>p.category===activeFilter);return(<div style={{display:"flex",flexDirection:"column",gap:"12px",maxWidth:"480px",width:"100%"}}><div style={{display:"flex",gap:"6px",overflowX:"auto",paddingBottom:"4px"}}><button onClick={()=>setActiveFilter("all")} style={{padding:"6px 14px",borderRadius:"20px",border:"none",background:activeFilter==="all"?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.04)",color:activeFilter==="all"?"#fff":"rgba(255,255,255,0.4)",fontSize:"12px",fontWeight:600,cursor:"pointer",whiteSpace:"nowrap"}}>{L("all")}</button>{CATS.map(cat=>(<button key={cat.id} onClick={()=>setActiveFilter(cat.id)} style={{padding:"6px 14px",borderRadius:"20px",border:"none",background:activeFilter===cat.id?`${cat.color}25`:"rgba(255,255,255,0.04)",color:activeFilter===cat.id?cat.color:"rgba(255,255,255,0.4)",fontSize:"12px",fontWeight:600,cursor:"pointer",whiteSpace:"nowrap"}}>{cat.emoji} {cat.label}</button>))}</div>{loading?(<Glass style={{padding:"40px 24px",textAlign:"center"}}><div style={{fontSize:"32px",marginBottom:"12px",animation:"pulse 1.5s infinite"}}><style>{`@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}`}</style>ğŸ”„</div><p style={{color:"rgba(255,255,255,0.4)",fontSize:"14px"}}>{L("loading")}</p></Glass>):filtered.length===0?(<Glass style={{padding:"40px 24px",textAlign:"center"}}><div style={{fontSize:"40px",marginBottom:"12px"}}>ğŸ’¬</div><p style={{color:"rgba(255,255,255,0.4)",fontSize:"14px"}}>{activeFilter==="all"?L("empty"):L("emptyCategory")}</p></Glass>):filtered.map((post)=>{const cat=CATS.find(c=>c.id===post.category)||CATS[0];const liked=(post.likedBy||[]).includes(uid);const likeCount=post.likes||0;const isOpen=openComments===post.id;const cmts=postComments[post.id]||[];return(<Glass key={post.id} style={{padding:"0",overflow:"hidden",animation:"fadeUp 0.4s ease"}}><div style={{padding:"16px 20px 12px",display:"flex",alignItems:"center",gap:"12px"}}><div style={{width:"40px",height:"40px",borderRadius:"50%",overflow:"hidden",background:post.avatar?"none":"linear-gradient(135deg,#FF6B35,#A855F7)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"20px",flexShrink:0,border:"2px solid rgba(255,255,255,0.1)"}}>{post.avatar?<img src={post.avatar} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{color:"#fff",fontSize:"16px"}}>{(post.displayName||post.username||"?")[0].toUpperCase()}</span>}</div><div style={{flex:1}}><div style={{display:"flex",alignItems:"center",gap:"6px"}}><span onClick={()=>!post.isMe&&onViewProfile&&onViewProfile(post.uid)} style={{color:"#fff",fontSize:"14px",fontWeight:600,cursor:post.isMe?"default":"pointer"}}>{post.displayName||post.username}</span>{post.username&&<span style={{color:"rgba(255,255,255,0.3)",fontSize:"11px"}}>@{post.username}</span>}{post.isMe&&<span style={{background:"linear-gradient(135deg,#FF6B35,#A855F7)",padding:"2px 8px",borderRadius:"10px",fontSize:"10px",color:"#fff",fontWeight:600}}>{L("you")}</span>}</div><div style={{color:"rgba(255,255,255,0.3)",fontSize:"11px",marginTop:"2px"}}>{post.time}</div></div><div style={{display:"flex",alignItems:"center",gap:"6px"}}><span style={{background:`${cat.color}20`,padding:"4px 10px",borderRadius:"12px",fontSize:"11px",color:cat.color,fontWeight:600}}>{cat.emoji}</span>{post.isMe&&<button onClick={()=>handleDeletePost(post.id)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.2)",fontSize:"16px",cursor:"pointer",padding:"4px"}}>ğŸ—‘ï¸</button>}</div></div><div style={{padding:"0 20px 8px"}}><div style={{color:"rgba(255,255,255,0.7)",fontSize:"15px",fontWeight:600}}>{post.title}</div></div><div style={{padding:"0 20px 16px"}}><p style={{color:"rgba(255,255,255,0.55)",fontSize:"14px",lineHeight:1.6,margin:0}}>{post.note}</p>{post.photo&&<img src={post.photo} onClick={(e)=>{e.stopPropagation();onPhotoClick&&onPhotoClick(post.photo)}} style={{width:"100%",borderRadius:"12px",marginTop:"12px",maxHeight:"250px",objectFit:"cover",cursor:"zoom-in"}}/>}{post.isLocation&&post.placeName&&(<a href={post.placeLat?mapLink(post.placeLat,post.placeLon,post.placeName,post.placeCity):mapLinkName(post.placeName,post.placeCity)} target="_blank" rel="noopener noreferrer" style={{display:"inline-flex",alignItems:"center",gap:"6px",marginTop:"10px",padding:"6px 12px",borderRadius:"8px",background:"rgba(16,185,129,0.1)",color:"#10B981",fontSize:"12px",fontWeight:600,textDecoration:"none"}}>{t(lang,"map.openMap")}</a>)}</div><div style={{padding:"0 20px 12px",display:"flex",alignItems:"center",gap:"12px"}}><button onClick={()=>handleLike(post.id)} style={{display:"flex",alignItems:"center",gap:"6px",border:"none",cursor:"pointer",padding:"6px 12px",borderRadius:"20px",background:liked?"rgba(239,68,68,0.1)":"rgba(255,255,255,0.04)"}}><span style={{fontSize:"16px"}}>{liked?"â¤ï¸":"ğŸ¤"}</span><span style={{color:liked?"#EF4444":"rgba(255,255,255,0.4)",fontSize:"13px",fontWeight:600}}>{likeCount}</span></button><button onClick={()=>handleToggleComments(post.id)} style={{display:"flex",alignItems:"center",gap:"6px",border:"none",cursor:"pointer",padding:"6px 12px",borderRadius:"20px",background:isOpen?"rgba(59,130,246,0.1)":"rgba(255,255,255,0.04)"}}><span style={{fontSize:"16px"}}>ğŸ’¬</span><span style={{color:isOpen?"#3B82F6":"rgba(255,255,255,0.4)",fontSize:"13px",fontWeight:600}}>{cmts.length||""}</span></button></div>{isOpen&&(<div style={{borderTop:"1px solid rgba(255,255,255,0.06)",padding:"12px 20px 16px",animation:"fadeUp 0.3s ease"}}>{cmts.length>0?cmts.map((c,ci)=>(<div key={ci} style={{display:"flex",gap:"10px",marginBottom:"12px"}}><div style={{width:"28px",height:"28px",borderRadius:"50%",overflow:"hidden",background:c.avatar?"none":(c.uid===uid?"linear-gradient(135deg,#FF6B35,#A855F7)":"rgba(255,255,255,0.08)"),display:"flex",alignItems:"center",justifyContent:"center",fontSize:"12px",flexShrink:0,color:"#fff",fontWeight:700}}>{c.avatar?<img src={c.avatar} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:(c.displayName||"?")[0].toUpperCase()}</div><div style={{flex:1}}><div style={{display:"flex",alignItems:"center",gap:"6px"}}><span style={{color:"#fff",fontSize:"12px",fontWeight:600}}>{c.displayName||c.username}</span><span style={{color:"rgba(255,255,255,0.25)",fontSize:"10px"}}>{timeAgo(c.createdAt,lang)}</span>{c.uid===uid&&<button onClick={()=>handleDeleteComment(post.id,c.id)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.2)",fontSize:"12px",cursor:"pointer",padding:"0 4px"}}>ğŸ—‘ï¸</button>}</div><p style={{color:"rgba(255,255,255,0.5)",fontSize:"13px",lineHeight:1.5,margin:"4px 0 0"}}>{c.text}</p></div></div>)):(<p style={{color:"rgba(255,255,255,0.25)",fontSize:"13px",textAlign:"center",margin:"8px 0"}}>{L("firstComment")}</p>)}<div style={{display:"flex",gap:"8px",marginTop:"8px"}}><input type="text" placeholder={L("writeComment")} value={newComment} onChange={e=>setNewComment(e.target.value)} onKeyDown={e=>e.key==="Enter"&&handleComment(post.id)} style={{flex:1,padding:"10px 14px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"#fff",fontSize:"13px",outline:"none",boxSizing:"border-box"}}/><button onClick={()=>handleComment(post.id)} style={{padding:"10px 16px",borderRadius:"12px",border:"none",background:newComment.trim()?"linear-gradient(135deg,#3B82F6,#2563EB)":"rgba(255,255,255,0.06)",color:newComment.trim()?"#fff":"rgba(255,255,255,0.2)",fontSize:"13px",fontWeight:600,cursor:newComment.trim()?"pointer":"default"}}>{L("send")}</button></div></div>)}</Glass>)})}<button onClick={loadPosts} style={{padding:"12px",borderRadius:"14px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"rgba(255,255,255,0.5)",fontSize:"13px",fontWeight:600,cursor:"pointer",marginTop:"4px"}}>{L("refresh")}</button></div>)}
export default function App(){const[authUser,setAuthUser]=useState(undefined);const[profile,setProfile]=useState(null);const[state,setState]=useState(()=>storage.get("wanderly-state")||DEFAULT_STATE);const[tab,setTab]=useState("today");const[completed,setCompleted]=useState(false);const[envChoice,setEnvChoice]=useState(null);const[lightboxPhoto,setLightboxPhoto]=useState(null);const[profileLoading,setProfileLoading]=useState(true);const[viewingProfile,setViewingProfile]=useState(null);const[dmView,setDmView]=useState(null);const[conversations,setConversations]=useState([]);const[dmChat,setDmChat]=useState(null);const lang=state.lang||"tr";const setLang=(l)=>saveState({...state,lang:l});const saveState=useCallback((ns)=>{setState(ns);storage.set("wanderly-state",ns)},[]);const CATS=getCats(lang);const DIFFS=getDiffs(lang);const ENVS=getEnvs(lang);const extra=addTranslations(lang);useEffect(()=>{const unsub=onAuthChange(async(user)=>{setAuthUser(user);if(user){const p=await getUserProfile(user.uid);setProfile(p)}setProfileLoading(false)});return unsub},[]);useEffect(()=>{if(authUser&&profile&&state.onboarded&&state.todayDate!==getToday()){setEnvChoice(null);saveState({...state,todayAdventure:null,todayDate:null,skipsToday:0})}},[authUser,profile,state.onboarded]);useEffect(()=>{if(authUser&&tab==="dm"){getConversations(authUser.uid).then(setConversations)}},[tab,authUser]);useEffect(()=>{if(state.notificationsEnabled&&"serviceWorker" in navigator){navigator.serviceWorker.register("/sw.js").catch(()=>{});scheduleLocalNotification()}},[state.notificationsEnabled]);const handleAuth=async(uid,googleName)=>{const p=await getUserProfile(uid);if(p)setProfile(p)};const handleProfileComplete=({username,displayName,avatar})=>{setProfile({username,displayName,avatar})};const handleOnboardComplete=({interests,difficulty,locationEnabled,city,lat,lon,nearbyPlaces})=>{saveState({...state,interests,difficulty,locationEnabled,city,lat,lon,nearbyPlaces,onboarded:true,todayAdventure:null,todayDate:null})};const handleComplete=async(note,photo)=>{const adv=state.todayAdventure;const today=getToday();const yesterday=new Date(Date.now()-86400000).toISOString().split("T")[0];let ns=state.lastCompletedDate===yesterday?state.streak+1:1;let xp=state.xp+adv.xp,lv=state.level;while(xp>=xpForLevel(lv)){xp-=xpForLevel(lv);lv++}saveState({...state,xp,level:lv,streak:ns,bestStreak:Math.max(state.bestStreak,ns),completedAdventures:[...state.completedAdventures,{...adv,date:today,note,photo:photo||null}],lastCompletedDate:today,locationAdventureCount:(state.locationAdventureCount||0)+(adv.isLocation?1:0)});setCompleted(true);if(note&&note.trim()&&profile){const uid=getCurrentUid();if(uid)shareAdventure({uid,username:profile.username,displayName:profile.displayName,avatar:profile.avatar,title:adv.title,category:adv.category,note:note.trim(),photo,isLocation:adv.isLocation||false,placeName:adv.placeName||null,placeLat:adv.placeLat||null,placeLon:adv.placeLon||null,placeCity:adv.placeCity||null})}};const handleSkip=()=>{const skips=state.skipsToday||0;if(skips>=2)return;const ct=state.completedAdventures.map(a=>a.title).concat([state.todayAdventure?.title]);const adv=getRandomAdventure(state.interests,state.difficulty,ct,state.nearbyPlaces,state.locationEnabled,envChoice,lang,state.city);saveState({...state,todayAdventure:adv,skipsToday:skips+1})};const toggleLocation=async()=>{if(state.locationEnabled){saveState({...state,locationEnabled:false,city:null,nearbyPlaces:[],lat:null,lon:null})}else if(navigator.geolocation){navigator.geolocation.getCurrentPosition(async(pos)=>{const lt=pos.coords.latitude,ln=pos.coords.longitude;let cn="OK";try{const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lt}&lon=${ln}&format=json&accept-language=${lang}`);const data=await res.json();cn=data.address?.city||data.address?.town||data.address?.province||cn}catch{}const places=await fetchNearbyPlaces(lt,ln);saveState({...state,locationEnabled:true,city:cn,lat:lt,lon:ln,nearbyPlaces:places})},()=>{})}};const handleLogout=async()=>{if(window.confirm(t(lang,"settings.logoutConfirm"))){await logoutUser();setProfile(null);setAuthUser(null)}};const handleAvatarUpdate=async(e)=>{const f=e.target.files[0];if(!f||!authUser)return;const r=new FileReader();r.onload=async(ev)=>{const img=new Image();img.onload=async()=>{const c=document.createElement("canvas");c.width=150;c.height=150;const ctx=c.getContext("2d");const s=Math.min(img.width,img.height);const sx=(img.width-s)/2;const sy=(img.height-s)/2;ctx.drawImage(img,sx,sy,s,s,0,0,150,150);const avatar=c.toDataURL("image/jpeg",0.7);await updateUserProfile(authUser.uid,{avatar});setProfile(prev=>({...prev,avatar}))};img.src=ev.target.result};r.readAsDataURL(f)};const handleViewProfile=(uid)=>{setViewingProfile(uid);setTab("profile")};const handleStartDM=async(targetProfile)=>{if(!authUser)return;const convId=await getOrCreateConversation(authUser.uid,targetProfile.id);if(convId){setDmChat({convId,otherProfile:targetProfile});setTab("dm")}};const handleOpenChat=(conv,prof)=>{setDmChat({convId:conv.id,otherProfile:prof})};const handleNotificationToggle=async()=>{if(state.notificationsEnabled){saveState({...state,notificationsEnabled:false})}else{const p=await requestNotificationPermission();if(p==="granted"){saveState({...state,notificationsEnabled:true})}else{alert(extra.notifications.denied)}}};const SL=k=>t(lang,"settings."+k);if(authUser===undefined||profileLoading)return(<><AnimatedBg/><div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",position:"relative",zIndex:1}}><div style={{color:"rgba(255,255,255,0.5)",fontSize:"18px",animation:"pulse 1.5s infinite"}}><style>{`@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}`}</style>ğŸŒ {lang==="en"?"Loading...":"YÃ¼kleniyor..."}</div></div></>);const FONTS=<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>;const STYLES=<style>{`*{margin:0;padding:0;box-sizing:border-box;font-family:'DM Sans',sans-serif}@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}`}</style>;if(!authUser)return(<><AnimatedBg/>{FONTS}{STYLES}<AuthScreen onAuth={handleAuth} lang={lang} setLang={setLang}/></>);if(!profile)return(<><AnimatedBg/>{FONTS}{STYLES}<ProfileSetup uid={authUser.uid} initialName={authUser.displayName||""} onComplete={handleProfileComplete} lang={lang}/></>);if(!state.onboarded)return(<><AnimatedBg/>{FONTS}{STYLES}<Onboarding onComplete={handleOnboardComplete} lang={lang}/></>);const done=state.lastCompletedDate===getToday()||completed;const TABS=[{id:"today",label:t(lang,"app.today"),emoji:"âš¡"},{id:"community",label:t(lang,"app.community"),emoji:"ğŸ’¬"},{id:"dm",label:friendTranslations(lang).friends,emoji:"ğŸ‘¥"},{id:"stats",label:t(lang,"app.stats"),emoji:"ğŸ“Š"},{id:"history",label:t(lang,"app.history"),emoji:"ğŸ“œ"},{id:"settings",label:t(lang,"app.settings"),emoji:"âš™ï¸"}];return(<>{lightboxPhoto&&<PhotoLightbox src={lightboxPhoto} onClose={()=>setLightboxPhoto(null)}/>}<AnimatedBg/>{FONTS}{STYLES}<div style={{position:"relative",zIndex:1,minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",padding:"20px 16px 100px",width:"100%"}}><div style={{width:"100%",maxWidth:"480px",display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"}}><div style={{display:"flex",alignItems:"center",gap:"12px"}}><Avatar src={profile.avatar} name={profile.displayName} size={38}/><div><h1 style={{fontFamily:"'Playfair Display',Georgia,serif",fontSize:"22px",fontWeight:700,color:"#fff"}}>Wanderly</h1><p style={{color:"rgba(255,255,255,0.4)",fontSize:"12px",marginTop:"1px"}}>@{profile.username}{state.city&&<span style={{marginLeft:"6px"}}>ğŸ“ {state.city}</span>}</p></div></div><div style={{background:"linear-gradient(135deg,#FF6B3520,#A855F720)",padding:"8px 16px",borderRadius:"20px",display:"flex",alignItems:"center",gap:"6px"}}><span style={{fontSize:"14px"}}>â­</span><span style={{color:"#FF6B35",fontSize:"14px",fontWeight:700}}>Lv.{state.level}</span></div></div><div style={{display:"flex",gap:"3px",marginBottom:"24px",background:"rgba(255,255,255,0.04)",padding:"4px",borderRadius:"14px",maxWidth:"480px",width:"100%",overflowX:"auto"}}>{TABS.map(tb=>(<button key={tb.id} onClick={()=>{setTab(tb.id);setViewingProfile(null);setDmChat(null)}} style={{flex:1,padding:"10px 4px",borderRadius:"10px",border:"none",background:tab===tb.id?"rgba(255,255,255,0.1)":"transparent",color:tab===tb.id?"#fff":"rgba(255,255,255,0.4)",fontSize:"11px",fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",minWidth:0}}>{tb.emoji} {tb.label}</button>))}</div>{tab==="today"&&(<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",minHeight:"60vh"}}>{done?(<Glass style={{padding:"40px 24px",textAlign:"center",maxWidth:"480px",width:"100%",animation:"fadeUp 0.5s ease"}}><div style={{fontSize:"56px",marginBottom:"16px"}}>ğŸ‰</div><h2 style={{color:"#fff",fontSize:"22px",fontWeight:700,marginBottom:"8px",fontFamily:"'Playfair Display',Georgia,serif"}}>{t(lang,"done.title")}</h2><p style={{color:"rgba(255,255,255,0.45)",fontSize:"14px",marginBottom:"24px"}}>{t(lang,"done.great")}{state.streak>1&&` ${tf(lang,"done.streak",{n:state.streak})}`}</p><button onClick={()=>{setCompleted(false);setEnvChoice(null);saveState({...state,todayAdventure:null,lastCompletedDate:null})}} style={{padding:"12px 28px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.15)",background:"rgba(255,255,255,0.06)",color:"rgba(255,255,255,0.7)",fontSize:"14px",fontWeight:600,cursor:"pointer"}}>{t(lang,"done.bonus")}</button></Glass>):!state.todayAdventure?(<Glass style={{padding:"32px 24px",textAlign:"center",maxWidth:"480px",width:"100%",animation:"fadeUp 0.5s ease"}}><div style={{fontSize:"40px",marginBottom:"12px"}}>ğŸ—ºï¸</div><h2 style={{color:"#fff",fontSize:"20px",fontWeight:700,marginBottom:"6px",fontFamily:"'Playfair Display',Georgia,serif"}}>{t(lang,"envSelect.title")}</h2><p style={{color:"rgba(255,255,255,0.4)",fontSize:"13px",marginBottom:"20px"}}>{t(lang,"envSelect.subtitle")}</p><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}}>{ENVS.map(e=>(<button key={e.id} onClick={()=>{setEnvChoice(e.id);const ct=state.completedAdventures.map(a=>a.title);const adv=getRandomAdventure(state.interests,state.difficulty,ct,state.nearbyPlaces,state.locationEnabled,e.id,lang,state.city);saveState({...state,todayAdventure:adv,todayDate:getToday(),skipsToday:0})}} style={{padding:"18px 12px",borderRadius:"14px",border:"2px solid rgba(255,255,255,0.08)",background:"rgba(255,255,255,0.03)",cursor:"pointer",textAlign:"center"}}><div style={{fontSize:"30px",marginBottom:"8px"}}>{e.emoji}</div><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>{e.label}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"11px",marginTop:"4px"}}>{e.desc}</div></button>))}</div></Glass>):<AdventureCard adventure={state.todayAdventure} onComplete={handleComplete} onSkip={handleSkip} skipsLeft={2-(state.skipsToday||0)} lang={lang}/>}</div>)}{tab==="community"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",maxWidth:"480px",minHeight:"60vh"}}><Community state={state} profile={profile} onPhotoClick={setLightboxPhoto} lang={lang} onViewProfile={handleViewProfile}/></div>}{tab==="profile"&&viewingProfile&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",minHeight:"60vh"}}><UserProfileView uid={viewingProfile} onBack={()=>{setTab("community");setViewingProfile(null)}} onStartDM={handleStartDM} lang={lang}/></div>}{tab==="dm"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",minHeight:"60vh"}}><FriendsTab currentUid={authUser.uid} lang={lang} onViewProfile={handleViewProfile}/></div>}{tab==="stats"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",minHeight:"60vh"}}><StatsPanel state={state} lang={lang}/></div>}{tab==="history"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",minHeight:"60vh"}}><History adventures={state.completedAdventures} onPhotoClick={setLightboxPhoto} lang={lang}/></div>}{tab==="settings"&&(<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%",gap:"12px",maxWidth:"480px",minHeight:"60vh"}}><Glass style={{padding:"24px",width:"100%",animation:"fadeUp 0.5s ease"}}><h2 style={{color:"#fff",fontSize:"18px",fontWeight:700,marginBottom:"20px"}}>âš™ï¸ {SL("title")}</h2><div style={{display:"flex",alignItems:"center",gap:"16px",padding:"16px",borderRadius:"14px",background:"rgba(255,255,255,0.03)",marginBottom:"20px"}}><label style={{cursor:"pointer"}}><div style={{width:"56px",height:"56px",borderRadius:"50%",overflow:"hidden",background:profile.avatar?"none":"linear-gradient(135deg,#FF6B35,#A855F7)",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid rgba(255,255,255,0.15)"}}>{profile.avatar?<img src={profile.avatar} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{color:"#fff",fontSize:"22px"}}>{profile.displayName[0].toUpperCase()}</span>}</div><input type="file" accept="image/*" style={{display:"none"}} onChange={handleAvatarUpdate}/></label><div style={{flex:1}}><div style={{color:"#fff",fontSize:"15px",fontWeight:600}}>{profile.displayName}</div><div style={{color:"rgba(255,255,255,0.4)",fontSize:"12px"}}>@{profile.username}</div><div style={{color:"rgba(255,255,255,0.25)",fontSize:"11px",marginTop:"2px"}}>{SL("changePhoto")}</div></div></div><div style={{marginBottom:"20px"}}><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>{SL("language")}</div><div style={{display:"flex",gap:"8px"}}><button onClick={()=>setLang("tr")} style={{flex:1,padding:"10px",borderRadius:"12px",border:`2px solid ${lang==="tr"?"#FF6B35":"rgba(255,255,255,0.08)"}`,background:lang==="tr"?"rgba(255,107,53,0.1)":"rgba(255,255,255,0.02)",color:lang==="tr"?"#FF6B35":"rgba(255,255,255,0.5)",fontSize:"14px",fontWeight:600,cursor:"pointer"}}>ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e</button><button onClick={()=>setLang("en")} style={{flex:1,padding:"10px",borderRadius:"12px",border:`2px solid ${lang==="en"?"#FF6B35":"rgba(255,255,255,0.08)"}`,background:lang==="en"?"rgba(255,107,53,0.1)":"rgba(255,255,255,0.02)",color:lang==="en"?"#FF6B35":"rgba(255,255,255,0.5)",fontSize:"14px",fontWeight:600,cursor:"pointer"}}>ğŸ‡¬ğŸ‡§ English</button></div></div><div style={{marginBottom:"20px"}}><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>{extra.notifications.daily}</div><button onClick={handleNotificationToggle} style={{width:"100%",padding:"12px 16px",borderRadius:"12px",border:`2px solid ${state.notificationsEnabled?"rgba(16,185,129,0.3)":"rgba(255,255,255,0.08)"}`,background:state.notificationsEnabled?"rgba(16,185,129,0.1)":"rgba(255,255,255,0.02)",color:state.notificationsEnabled?"#10B981":"rgba(255,255,255,0.5)",fontSize:"13px",fontWeight:600,cursor:"pointer"}}>{state.notificationsEnabled?extra.notifications.enabled:extra.notifications.enable}</button></div><div style={{marginBottom:"20px"}}><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>{SL("location")}</div><div style={{padding:"14px 16px",borderRadius:"12px",background:"rgba(255,255,255,0.03)"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}><div><div style={{color:"#fff",fontSize:"14px",fontWeight:600}}>ğŸ“ {SL("locationBased")}</div><div style={{color:"rgba(255,255,255,0.35)",fontSize:"12px",marginTop:"4px"}}>{state.locationEnabled?`${state.city||SL("active")} â€” ${(state.nearbyPlaces||[]).length} ${lang==="en"?"places":"mekan"}`:SL("disabled")}</div></div><button onClick={toggleLocation} style={{padding:"8px 16px",borderRadius:"20px",border:"none",background:state.locationEnabled?"rgba(16,185,129,0.2)":"rgba(255,255,255,0.1)",color:state.locationEnabled?"#10B981":"rgba(255,255,255,0.5)",fontSize:"13px",fontWeight:600,cursor:"pointer"}}>{state.locationEnabled?SL("locationOn"):SL("locationOff")}</button></div></div></div><div style={{marginBottom:"20px"}}><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>{SL("difficulty")}</div><div style={{display:"flex",gap:"8px"}}>{DIFFS.map(d=>(<button key={d.id} onClick={()=>saveState({...state,difficulty:d.id})} style={{flex:1,padding:"10px 8px",borderRadius:"12px",border:`2px solid ${state.difficulty===d.id?"#FF6B35":"rgba(255,255,255,0.08)"}`,background:state.difficulty===d.id?"rgba(255,107,53,0.1)":"rgba(255,255,255,0.02)",color:state.difficulty===d.id?"#FF6B35":"rgba(255,255,255,0.5)",fontSize:"13px",fontWeight:600,cursor:"pointer"}}>{d.emoji} {d.label}</button>))}</div></div><div style={{marginBottom:"20px"}}><div style={{color:"rgba(255,255,255,0.5)",fontSize:"12px",fontWeight:600,textTransform:"uppercase",letterSpacing:"1px",marginBottom:"12px"}}>{SL("categories")}</div><div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:"8px"}}>{CATS.map(cat=>{const sel=state.interests.includes(cat.id);return(<button key={cat.id} onClick={()=>{const ni=sel?state.interests.filter(x=>x!==cat.id):[...state.interests,cat.id];if(ni.length>=2)saveState({...state,interests:ni})}} style={{padding:"10px 6px",borderRadius:"10px",border:`2px solid ${sel?cat.color:"rgba(255,255,255,0.08)"}`,background:sel?`${cat.color}18`:"rgba(255,255,255,0.02)",color:sel?cat.color:"rgba(255,255,255,0.4)",fontSize:"12px",fontWeight:600,cursor:"pointer"}}>{cat.emoji} {cat.label}</button>)})}</div><div style={{color:"rgba(255,255,255,0.25)",fontSize:"11px",marginTop:"6px"}}>{SL("minCategories")}</div></div><div style={{borderTop:"1px solid rgba(255,255,255,0.06)",paddingTop:"16px",display:"flex",flexDirection:"column",gap:"10px"}}><button onClick={handleLogout} style={{width:"100%",padding:"12px",borderRadius:"12px",border:"1px solid rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.04)",color:"rgba(255,255,255,0.5)",fontSize:"13px",fontWeight:600,cursor:"pointer"}}>{SL("logout")}</button><button onClick={()=>{if(window.confirm(SL("resetConfirm"))){localStorage.clear();window.location.reload()}}} style={{width:"100%",padding:"12px",borderRadius:"12px",border:"1px solid rgba(239,68,68,0.3)",background:"rgba(239,68,68,0.08)",color:"#EF4444",fontSize:"13px",fontWeight:600,cursor:"pointer"}}>{SL("reset")}</button></div></Glass></div>)}</div></>)}
